<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $rootScope, spUtil) {
  /* widget controller */
  var c = this;
	
	$scope.show_approvals = true;		
	
	if (c.data.showApprovals)
		spUtil.recordWatch($scope, "sysapproval_approver", "state=requested^approverIN" +  $scope.data.approvals.myApprovals.toString());

	
	function get() {
		spUtil.update($scope);
	}

	$scope.approve = function(id) {
		$scope.data.op = "approved";
		$scope.data.target = id;
		get();
	};

	$scope.reject = function(id) {
		$scope.data.op = "rejected";
		$scope.data.target = id;
		get();
	};

	
}]]></client_script>
        <controller_as>c</controller_as>
        <css>@media only screen and (max-width : 991px) {
	.panels-container {
 	  min-height : 240px;
	}
}

@media only screen and (min-width : 992px) {
	.panels-container {
 	  min-height : 240px;
	}
}

@media only screen and (max-width : 700px) {
	.ssp-panel-widget {
 	  height : 95%;
	}
}

.panel-body {
	padding-left: 25px;
}
.list-group-links {
	padding-top: 10px;
}

.panels-container-links {
  margin-bottom: 10px;
}
.panels-container-requests {
  margin-bottom: 0px;
}
.panels-container-approval {
  margin-bottom: 0px;
}
.overflow-links {
  margin-top: 10px;
  height : 220px;
  max-height : 220px;
	overflow: auto;
}
.overflow-requests {
  height : 255px !important;
  max-height : 255px;
	overflow: auto;
}
.overflow-approvals {
  height : 255px !important;
  max-height : 255px;
	overflow: auto;
}
.sp-approval &gt; .approval-rows {
  padding: 10px;
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>epsp_oc_approvals_2</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>EPSP OC Approvals 2</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */

	if (input) {
		if (input.op == 'approved' || input.op == 'rejected') {
			var app = new GlideRecord("sysapproval_approver");
			if (app.get(input.target) && app.state.canWrite()) {
				app.state = input.op;
				app.update();
			}
		}
	}
	
	function getField(gr, name) {
		var f = {};
		var id = gr.getUniqueValue();
		gr = new GlideRecord(gr.getRecordClassName());
		gr.get(id);
		f.display_value = gr.getDisplayValue(name);
		f.value = gr.getValue(name);
		var ge = gr.getElement(name);
		if (ge) {
			var ed = ge.getED();
			if (ed)
				f.type = ed.getInternalType();
			f.label = ge.getLabel();
		}
		return f;
	}

	function getMyApprovalsIds() {
		var u = gs.getUserID();
		var answer = [];
		var i = 0;
		answer[i++] = u + '';
		var g = new GlideRecord("sys_user_delegate");
		g.addQuery("delegate", u);
		g.addQuery("approvals", "true");
		g.addQuery("starts", "<=", gs.daysAgo(0));
		g.addQuery("ends", ">=", gs.daysAgo(0));
		g.query();
		while( g.next())
			answer[i++] = g.user + '';
		return answer;
	}	
	
	// fetch approvals for the user.
	data.approvals = {};
	
	// data.showApprovals = gs.getUser().hasRole('approver_user');
	data.showApprovals = true;
	
	// Retreive approvals related to the User.
	if (data.showApprovals) {
		gr = new GlideRecord('sysapproval_approver');
		gr.chooseWindow(0, 10);
		var qc1 = gr.addQuery("state", "requested");
		data.approvals.myApprovals = getMyApprovalsIds();
		gr.addQuery("approver", data.approvals.myApprovals);
		gr.orderBy("sys_created_on");
		gr.query();

		var approvalsCount = gr.getRowCount();
		var approvals = [];
		var ids = [];

		while (gr.next()) {
			var task = getRecordBeingApproved(gr);
			if (!task.isValidRecord())
				continue;

			ids.push(gr.getUniqueValue());
			var t = {};
			t.number = task.getDisplayValue();
			t.short_description = task.short_description.toString();
			if (gr.getValue("approver") != gs.getUserID())
				t.approver = gr.approver.getDisplayValue();
			if (task.isValidField("opened_by") && !task.opened_by.nil())
				t.opened_by = task.opened_by.getDisplayValue();
			// requestor >> opener
			if (task.isValidField("requested_by") && !task.requested_by.nil())
				t.opened_by = task.requested_by.getDisplayValue();

			t.start_date = task.getDisplayValue('start_date');
			t.end_date = task.getDisplayValue('end_date');
			t.quantity = task.getDisplayValue('quantity');
			t.table = task.getLabel();
			if (task.getValue("price") > 0)
				t.price = task.getDisplayValue("price");

			if (task.getValue("recurring_price") > 0)
				t.recurring_price = task.getDisplayValue("recurring_price");

			t.recurring_frequency = task.getDisplayValue("recurring_frequency");

			var items = [];
			var idx = 0;
			var itemsGR = new GlideRecord("sc_req_item");
			itemsGR.addQuery("request", task.sys_id);
			itemsGR.query();
			if (itemsGR.getRowCount() > 1)
				t.short_description = itemsGR.getRowCount() + " requested items";

			while (itemsGR.next()) {
				var item = {};
				item.short_description = itemsGR.short_description.toString();
				if (itemsGR.getValue("price") > 0)
					item.price = itemsGR.getDisplayValue("price");
				if (itemsGR.getValue("recurring_price") > 0) {
					item.recurring_price = itemsGR.getDisplayValue("recurring_price");
					item.recurring_frequency = itemsGR.getDisplayValue("recurring_frequency");
				}
				if (itemsGR.getRowCount() == 1) {
					item.variables = $sp.getRecordVariablesArray(itemsGR);
					t.short_description = itemsGR.short_description.toString();
				}

				items[idx] = item;
				idx++;
			}

			var j = {};
			j.sys_id = gr.getUniqueValue();
			j.table = gr.getRecordClassName();
			j.task = t;
			if (task) {
				var optionsGr = task.request_item ? task.request_item.getRefRecord() : task;
				j.variables = $sp.getRecordVariablesArray(optionsGr);
			}

			j.items = items;
			j.state = gr.getValue("state");
			j.stateLabel = gr.state.getDisplayValue();
			approvals.push(j);
		}

		data.approvals.ids = ids;
		data.approvals.approval_list = approvals;
		if (approvals.length > 10)
			data.approvals.show_viewAll = true;

		data.approvals.hasAny = approvals.length > 0 ? true : false;
	}

	function getRecordBeingApproved(gr) {
		if (!gr.sysapproval.nil())
			return gr.sysapproval.getRefRecord();
		return gr.document_id.getRefRecord();
	}	
	
	
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admindavid</sys_created_by>
        <sys_created_on>2020-07-30 15:45:49</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>94c1e1cadbd6d090b83e790aaf96193e</sys_id>
        <sys_mod_count>19</sys_mod_count>
        <sys_name>EPSP OC Approvals 2</sys_name>
        <sys_package display_value="PersonaPortal" source="x_saico_eppersona">d2c8b27cdb4e981036d27e09af961908</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="PersonaPortal">d2c8b27cdb4e981036d27e09af961908</sys_scope>
        <sys_update_name>sp_widget_94c1e1cadbd6d090b83e790aaf96193e</sys_update_name>
        <sys_updated_by>admindavid</sys_updated_by>
        <sys_updated_on>2020-07-30 16:38:59</sys_updated_on>
        <template><![CDATA[<div class="panel panel-{{::options.color}} b">
  <div class="panel-heading">
    <h2 class="h4 panel-title"><fa ng-if="::options.glyph.length" name="{{::options.glyph}}" class="m-r-sm" />${My Approvals}
      <label ng-if="data.pagination.showPagination && (data.pagination.from <= data.pagination.to)" class="pull-right text-info"><span ng-if="data.pagination.from != data.pagination.to">{{data.pagination.from}} ${to_lower}</span> {{data.pagination.to}} of {{data.pagination.of}}</label></h2>
  </div>
  <div class="panel-body" ng-class="{'padder-b-none': data.approvals.length != 0}">
    <div ng-if="data.approvals.approval_list.length == 0">
      ${You have no pending approvals}
    </div>
    <div ng-repeat="approval in data.approvals.approval_list" class="sp-approval m-b-xl">
      <div class="row">
        <div ng-class="contentColClass">
          <div ng-if="approval.task.number || approval.task.short_description">
            <a ng-href="?id=oc_approval&table=sysapproval_approver&sys_id={{::approval.sys_id}}" title="{{data.ViewApprovalPageMsg}}">
              <span ng-if="approval.task.number">{{::approval.task.number}}</span>
              <span ng-if="approval.task.number && approval.task.short_description"> - </span>
              <span ng-if="approval.task.short_description">{{::approval.task.short_description}}</span>
            </a>
          </div>
          <div ng-if="approval.task.opened_by"><label><b>${Requestor}:</b></label> {{::approval.task.opened_by}}</div>
          <div ng-if="approval.task.approver"><label><b>${Approver}:</b></label> {{::approval.task.approver}}</div>
          <div ng-if="approval.task.start_date"><label><b>${Start}:</b></label> {{::approval.task.start_date}}</div>
          <div ng-if="approval.task.end_date"><label><b>${End}:</b></label> {{::approval.task.end_date}}</div>
          <div ng-if="approval.task.price"><label><b>${Price}:</b></label> {{::approval.task.price}}
            <span ng-if="approval.task.recurring_price"><label><b>${Recurring price}:</b></label> {{::approval.task.recurring_price}} {{::approval.task.recurring_frequency}}</span>
          </div>
          <div ng-if="approval.items.length == 1">
            <div ng-repeat="item in approval.items">
              <div ng-if="item.variables.length > 0" ng-init="variable_toggle=false">
                <a href="javascript:void(0)" ng-click="variable_toggle = !variable_toggle">
                  <span class="glyphicon"
                        ng-class="{'glyphicon-chevron-down': !variable_toggle, 'glyphicon-chevron-up': variable_toggle}">
                  </span>
                  ${Options}
                </a>
                <div ng-repeat="variable in item.variables" ng-if="variable_toggle">
                  <label class="text-muted">{{::variable.label}}</label>
                  <div>{{::variable.display_value}}</div>
                </div>
              </div>
            </div>
          </div>

          <div ng-if="approval.variables.length > 0" ng-init="variable_toggle=false">
            <a href="javascript:void(0)" ng-click="variable_toggle = !variable_toggle">
              <span class="glyphicon"
                    ng-class="{'glyphicon-chevron-down': !variable_toggle, 'glyphicon-chevron-up': variable_toggle}">
              </span>
              ${Options}
            </a>
            <div ng-repeat="variable in approval.variables" ng-if="variable_toggle">
              <label><b>{{::variable.label}}</b></label>
              <div>{{::variable.display_value}}</div>
            </div>
          </div>
        </div>

        <!-- <div ng-if="!options.portal" class="col-sm-3">
          <button name="approve" ng-if="approval.state == 'requested'" class="btn btn-primary btn-block" style="border-width:1px;" ng-click="approve(approval.sys_id, approval.requireEsigApproval);">${Approve}</button>
          <button name="reject" ng-if="approval.state == 'requested'" class="btn btn-default btn-block" ng-click="reject(approval.sys_id);">${Reject}</button>
          <button ng-if="approval.state == 'approved'" class="btn btn-success btn-block">{{approval.stateLabel}}</button>
          <button ng-if="approval.state == 'rejected'" class="btn btn-danger btn-block">{{approval.stateLabel}}</button>
          <button ng-if="approval.state != 'requested'" class="btn btn-default btn-block" style="visibility:hidden">{{approval.stateLabel}}</button>
        </div>
        <div ng-if="options.portal && approval.state == 'requested'" class="col-xs-6">
          <button name="reject" class="btn btn-default btn-block" ng-click="reject(approval.sys_id, approval.requireEsigApproval);">${Reject}</button>
        </div>
        <div ng-if="options.portal && approval.state == 'requested'" class="col-xs-6">
          <button name="approve" class="btn btn-primary btn-block" ng-click="approve(approval.sys_id, approval.requireEsigApproval);">${Approve}</button>
        </div>
        <div ng-if="options.portal && approval.state != 'requested'" class="col-xs-12">
          <button ng-if="approval.state == 'approved'" class="btn btn-success btn-block">{{approval.stateLabel}}</button>
          <button ng-if="approval.state == 'rejected'" class="btn btn-danger btn-block">{{approval.stateLabel}}</button>
        </div> -->
      </div>
    </div> <!-- body -->

  </div>
  <div class="panel-footer clearfix" ng-if="data.pagination.showPagination">
    <a id="previous-btn" href="javascript:void(0)" ng-click="previousPage()" ng-show="data.pagination.hasPrevious" class="pull-left btn btn-sm btn-default" aria-label="${Pagination button Previous}">
      <i class="fa fa-arrow-left m-r-sm" aria-hidden="true"></i>${Previous}</a>
    <a id="next_btn" href="javascript:void(0)" ng-click="nextPage()" ng-show="data.pagination.hasNext" class="pull-right btn btn-sm btn-default " aria-label="${Pagination button Next}">
      ${Next}<i class="fa fa-arrow-right m-r-sm col-md-offset-3" aria-hidden="true"></i></a>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
